// Prisma schema for NERIN Electric platform
// Auto-generated by ChatGPT to satisfy domain requirements

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  tecnico
  cliente
}

enum ProjectType {
  vivienda
  comercio
  oficina
  edificio
}

enum ProjectStatus {
  planificado
  en_progreso
  detenido
  finalizado
}

enum ProgressStatus {
  pendiente
  pagado
}

enum TicketStatus {
  abierto
  en_progreso
  resuelto
  cerrado
}

enum InvoiceStatus {
  pendiente
  emitida
  pagada
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  role          Role     @default(cliente)
  empresa       String?
  cuit          String?
  telefono      String?
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  // relations
  accounts      Account[]
  sessions      Session[]
  clientProfile Client?
  technician    Technician?
  tickets       TicketMessage[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Client {
  id         String   @id @default(cuid())
  userId     String   @unique
  direccion  String?
  ciudad     String?
  notas      String?
  approved   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects   Project[]
  tickets    Ticket[]
  maintenanceSubscriptions MaintenanceSubscription[]
}

model Project {
  id                   String           @id @default(cuid())
  clientId             String
  nombre               String
  tipo                 ProjectType
  estado               ProjectStatus   @default(planificado)
  direccion            String
  metros2              Int?
  normativasAplicadas  String[]        @default([])
  fechaInicio          DateTime?
  fechaFinEstimada     DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  client               Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quotes               ConfiguratorQuote[]
  workOrders           WorkOrder[]
  progressCertificates ProgressCertificate[]
  invoices             Invoice[]
  tickets              Ticket[]
}

model Pack {
  id                     String   @id @default(cuid())
  slug                   String   @unique
  nombre                 String
  descripcion            String
  soloManoObra           Boolean  @default(true)
  alcanceDetallado       String[]
  bocasIncluidas         Int
  ambientesReferencia    Int
  precioManoObraBase     Decimal  @db.Decimal(12, 2)
  destacado              Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  additionalItems        AdditionalItem[]
  configuratorQuotes     ConfiguratorQuote[]
}

model AdditionalItem {
  id                       String   @id @default(cuid())
  packId                   String?
  nombre                   String
  descripcion              String
  unidad                   String
  precioUnitarioManoObra   Decimal @db.Decimal(12, 2)
  reglasCompatibilidad     Json?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  pack                     Pack?    @relation(fields: [packId], references: [id])
  configuratorQuoteItems   ConfiguratorQuoteItem[]
}

model ConfiguratorQuote {
  id                        String                  @id @default(cuid())
  projectId                 String?
  packId                    String
  itemsSeleccionados        Json
  totalManoObra             Decimal                 @db.Decimal(12, 2)
  proyectoElectricoAparte   Decimal                 @db.Decimal(12, 2) @default(500000)
  materialesIncluidos       Boolean                 @default(false)
  aclaracionesMateriales    String?                 @default("Materiales se cotizan aparte según marcas.")
  pdfUrl                    String?
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  project                   Project?                @relation(fields: [projectId], references: [id])
  pack                      Pack                    @relation(fields: [packId], references: [id], onDelete: Cascade)
  clientViewToken           String?                 @unique
  configuratorQuoteItems    ConfiguratorQuoteItem[]
}

model ConfiguratorQuoteItem {
  id                  String           @id @default(cuid())
  quoteId             String
  additionalItemId    String?
  descripcion         String
  cantidad            Int      @default(1)
  precioUnitario      Decimal  @db.Decimal(12, 2)
  subtotal            Decimal  @db.Decimal(12, 2)
  quote               ConfiguratorQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  additionalItem      AdditionalItem?   @relation(fields: [additionalItemId], references: [id])
}

model MaintenancePlan {
  id                           String   @id @default(cuid())
  slug                         String   @unique
  nombre                       String
  incluyeTareasFijas           String[]
  visitasMes                   Int
  precioMensual                Decimal  @db.Decimal(12, 2)
  cantidadesFijasInalterables  Boolean  @default(true)
  descripcion                  String?
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  subscriptions                MaintenanceSubscription[]
}

model MaintenanceSubscription {
  id               String   @id @default(cuid())
  planId           String
  clientId         String
  estado           String   @default("pendiente")
  inicio           DateTime @default(now())
  mpPreferenceId   String?
  mpInitPointUrl   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  plan             MaintenancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  client           Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model WorkOrder {
  id              String   @id @default(cuid())
  projectId       String
  visitas         Int
  checklist       String[]
  fotos           String[]
  firmadoPorCliente Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProgressCertificate {
  id              String         @id @default(cuid())
  projectId       String
  porcentaje      Int
  monto           Decimal        @db.Decimal(12, 2)
  estado          ProgressStatus @default(pendiente)
  mpPreferenceId  String?
  mpInitPointUrl  String?
  paidAt          DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Invoice {
  id        String        @id @default(cuid())
  projectId String
  estado    InvoiceStatus @default(pendiente)
  urlPdf    String?
  fecha     DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model CaseStudy {
  id         String   @id @default(cuid())
  titulo     String
  slug       String   @unique
  resumen    String
  contenido  String
  fotos      String[]
  metricas   Json?
  publicado  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Brand {
  id      String   @id @default(cuid())
  nombre  String   @unique
  logoUrl String?
}

model Technician {
  id           String   @id @default(cuid())
  userId       String   @unique
  credenciales String[]
  fotoUrl      String?
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Ticket {
  id         String        @id @default(cuid())
  clientId   String
  projectId  String?
  asunto     String
  estado     TicketStatus @default(abierto)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  mensajes   TicketMessage[]
  client     Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project    Project?     @relation(fields: [projectId], references: [id])
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  mensaje   String
  creadoEn  DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SiteSetting {
  id               String   @id @default(cuid())
  whatsappNumber   String   @default("5491100000000")
  whatsappMessage  String   @default("Hola, soy [Nombre]. Quiero cotizar un servicio eléctrico con NERIN.")
  direccionOficina String   @default("CABA, Argentina")
  emailContacto    String   @default("hola@nerin.com.ar")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

